clear
clc
D=[0;3;8;6;12;5];       %各点的需求向量，可依实际情况修改
Q=[20;16];              %各车辆的承载能力向量，可依实际情况修改
Acost=[0,0,0,0,0,0;
   2,0,0,0,0,0;
   10,6,0,0,0,0;
   4,9,7,0,0,0;
   9,11,4,7,0,0;
   3,8,12,6,5,0];       %价格系数矩阵的初始形式，可依实际情况修改
Acost=Acost+Acost';     %使Acost成为对称矩阵
f=reshape(Acost,1,36);
f=[f,f];                %价格系数矩阵已生成
intcon=[1:1:72];        %72个X均为整数变量（0-1变量）
aeq1=[1,0,0,0,0,0];
aeq2=[0,1,0,0,0,0];
aeq3=[0,0,1,0,0,0];
aeq4=[0,0,0,1,0,0];
aeq5=[0,0,0,0,1,0];
aeq6=[0,0,0,0,0,1];
aeq7=[ones(1,6),zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6)];
aeq8=[zeros(1,6),ones(1,6),zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6)];
aeq9=[zeros(1,6),zeros(1,6),ones(1,6),zeros(1,6),zeros(1,6),zeros(1,6)];
aeq10=[zeros(1,6),zeros(1,6),zeros(1,6),ones(1,6),zeros(1,6),zeros(1,6)];
aeq11=[zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6),ones(1,6),zeros(1,6)];
aeq12=[zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6),zeros(1,6),ones(1,6)];
%%%%%%%%%%%%%%%%%%%%%%%%%%%%
aeq13=[-ones(1,6),aeq1,aeq1,aeq1,aeq1,aeq1,zeros(1,36)];
aeq14=[aeq2,-ones(1,6),aeq2,aeq2,aeq2,aeq2,zeros(1,36)];
aeq15=[aeq3,aeq3,-ones(1,6),aeq3,aeq3,aeq3,zeros(1,36)];
aeq16=[aeq4,aeq4,aeq4,-ones(1,6),aeq4,aeq4,zeros(1,36)];
aeq17=[aeq5,aeq5,aeq5,aeq5,-ones(1,6),aeq5,zeros(1,36)];
aeq18=[aeq6,aeq6,aeq6,aeq6,aeq6,-ones(1,6),zeros(1,36)];
aeq19=[zeros(1,36),-ones(1,6),aeq1,aeq1,aeq1,aeq1,aeq1];
aeq20=[zeros(1,36),aeq2,-ones(1,6),aeq2,aeq2,aeq2,aeq2];
aeq21=[zeros(1,36),aeq3,aeq3,-ones(1,6),aeq3,aeq3,aeq3];
aeq22=[zeros(1,36),aeq4,aeq4,aeq4,-ones(1,6),aeq4,aeq4];
aeq23=[zeros(1,36),aeq5,aeq5,aeq5,aeq5,-ones(1,6),aeq5];
aeq24=[zeros(1,36),aeq6,aeq6,aeq6,aeq6,aeq6,-ones(1,6)];
aeq1=[aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1,aeq1];
aeq2=[aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2,aeq2];
aeq3=[aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3,aeq3];
aeq4=[aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4,aeq4];
aeq5=[aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5,aeq5];
aeq6=[aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6,aeq6];
aeq7=[aeq7,aeq7];
aeq8=[aeq8,aeq8];
aeq9=[aeq9,aeq9];
aeq10=[aeq10,aeq10];
aeq11=[aeq11,aeq11];
aeq12=[aeq12,aeq12];
Aeq=[aeq2;aeq3;aeq4;aeq5;aeq6;aeq8;aeq9;aeq10;aeq11;aeq12;aeq13;aeq14;aeq15;aeq16;aeq17;aeq18;aeq19;aeq20;aeq21;aeq22;aeq23;aeq24];
                                %等式约束的技术系数矩阵已生成
beq=[ones(10,1);zeros(12,1)];   %等式约束的资源向量已生成
a=~aeq1;
%%%%%%%%%%
temp=zeros(6,6);
subtour=zeros(52,72);           %通过排列组合知，欲消除系统的子循环（subtour），需要52个不等式约束
count=1;
for n=2:1:5
    for m=(n+1):1:6
        temp(n,m)=1;
        temp=temp'+temp;
        temptemp=reshape(temp,[1,36]);
        subtour(count,:)=[temptemp,zeros(1,36)];
        subtour(count+10,:)=[zeros(1,36),temptemp];
        temp=zeros(6,6);
        count=count+1;
    end
end
%%%%%%%消除二元子循环
%%
subtour(21,:)=[0,0,0,0,0,0 ...
               0,0,1,1,0,0 ...
               0,1,0,1,0,0 ...
               0,1,1,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               zeros(1,36)];
subtour(22,:)=[0,0,0,0,0,0 ...
               0,0,1,0,1,0 ...
               0,1,0,0,1,0 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,0 ...
               0,0,0,0,0,0 ...
               zeros(1,36)];
subtour(23,:)=[0,0,0,0,0,0 ...
               0,0,1,0,0,1 ...
               0,1,0,0,0,1 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,0 ...
               zeros(1,36)];
subtour(24,:)=[0,0,0,0,0,0 ...
               0,0,0,1,1,0 ...
               0,0,0,0,0,0 ...
               0,1,0,0,1,0 ...
               0,1,0,1,0,0 ...
               0,0,0,0,0,0 ...
               zeros(1,36)];
subtour(25,:)=[0,0,0,0,0,0 ...
               0,0,0,1,0,1 ...
               0,0,0,0,0,0 ...
               0,1,0,0,0,1 ...
               0,0,0,0,0,0 ...
               0,1,0,1,0,0 ...
               zeros(1,36)];
subtour(26,:)=[0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,1,0,0,0,1 ...
               0,1,0,0,1,0 ...
               zeros(1,36)];
subtour(27,:)=[0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,0 ...
               0,0,1,0,1,0 ...
               0,0,1,1,0,0 ...
               0,0,0,0,0,0 ...
               zeros(1,36)];
subtour(28,:)=[0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,0,1 ...
               0,0,1,0,0,1 ...
               0,0,0,0,0,0 ...
               0,0,1,1,0,0 ...
               zeros(1,36)];
subtour(29,:)=[0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,0,1,0,0,1 ...
               0,0,1,0,1,0 ...
               zeros(1,36)];
subtour(30,:)=[0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,1,0,1 ...
               0,0,0,1,1,0 ...
               zeros(1,36)];
subtour(31,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,1,0,0 ...
               0,1,0,1,0,0 ...
               0,1,1,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0];
subtour(32,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,0,1,0 ...
               0,1,0,0,1,0 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,0 ...
               0,0,0,0,0,0];
subtour(33,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,0,0,1 ...
               0,1,0,0,0,1 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,0];
subtour(34,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,0 ...
               0,0,0,0,0,0 ...
               0,1,0,0,1,0 ...
               0,1,0,1,0,0 ...
               0,0,0,0,0,0];
subtour(35,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,1,0,1 ...
               0,0,0,0,0,0 ...
               0,1,0,0,0,1 ...
               0,0,0,0,0,0 ...
               0,1,0,1,0,0];
subtour(36,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,1,0,0,0,1 ...
               0,1,0,0,1,0];
subtour(37,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,0 ...
               0,0,1,0,1,0 ...
               0,0,1,1,0,0 ...
               0,0,0,0,0,0];
subtour(38,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,0,1 ...
               0,0,1,0,0,1 ...
               0,0,0,0,0,0 ...
               0,0,1,1,0,0];
subtour(39,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,0,1,0,0,1 ...
               0,0,1,0,1,0];
subtour(40,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,0,1,1 ...
               0,0,0,1,0,1 ...
               0,0,0,1,1,0];
%%%%%%%消除三元子循环
%%
subtour(41,:)=[0,0,0,0,0,0 ...
               0,0,1,1,1,0 ...
               0,1,0,1,1,0 ...
               0,1,1,0,1,0 ...
               0,1,1,1,0,0 ...
               0,0,0,0,0,0 ...
               zeros(1,36)];
subtour(42,:)=[0,0,0,0,0,0 ...
               0,0,1,1,0,1 ...
               0,1,0,1,0,1 ...
               0,1,1,0,0,1 ...
               0,0,0,0,0,0 ...
               0,1,1,1,0,0 ...
               zeros(1,36)];
subtour(43,:)=[0,0,0,0,0,0 ...
               0,0,1,0,1,1 ...
               0,1,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,1 ...
               0,1,1,0,1,0 ...
               zeros(1,36)];
subtour(44,:)=[0,0,0,0,0,0 ...
               0,0,0,1,1,1 ...
               0,0,0,0,0,0 ...
               0,1,0,0,1,1 ...
               0,1,0,1,0,1 ...
               0,1,0,1,1,0 ...
               zeros(1,36)];
subtour(45,:)=[0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,1 ...
               0,0,1,0,1,1 ...
               0,0,1,1,0,1 ...
               0,0,1,1,1,0 ...
               zeros(1,36)];
subtour(46,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,1,1,0 ...
               0,1,0,1,1,0 ...
               0,1,1,0,1,0 ...
               0,1,1,1,0,0 ...
               0,0,0,0,0,0];
subtour(47,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,1,0,1 ...
               0,1,0,1,0,1 ...
               0,1,1,0,0,1 ...
               0,0,0,0,0,0 ...
               0,1,1,1,0,0];
subtour(48,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,0,1,1 ...
               0,1,0,0,1,1 ...
               0,0,0,0,0,0 ...
               0,1,1,0,0,1 ...
               0,1,1,0,1,0];
subtour(49,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,1 ...
               0,0,0,0,0,0 ...
               0,1,0,0,1,1 ...
               0,1,0,1,0,1 ...
               0,1,0,1,1,0];
subtour(50,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,0,0,0,0 ...
               0,0,0,1,1,1 ...
               0,0,1,0,1,1 ...
               0,0,1,1,0,1 ...
               0,0,1,1,1,0];
%%%%%%%消除四元子循环
%%
subtour(51,:)=[0,0,0,0,0,0 ...
               0,0,1,1,1,1 ...
               0,1,0,1,1,1 ...
               0,1,1,0,1,1 ...
               0,1,1,1,0,1 ...
               0,1,1,1,1,0 ...
               zeros(1,36)];
subtour(52,:)=[zeros(1,36) ...
               0,0,0,0,0,0 ...
               0,0,1,1,1,1 ...
               0,1,0,1,1,1 ...
               0,1,1,0,1,1 ...
               0,1,1,1,0,1 ...
               0,1,1,1,1,0];
%%%%%%%消除五元子循环
%%
% imshow(subtour);          %subtour矩阵对应的二值化图像很有意思
A=[D(1,:)*ones(1,6),D(2,:)*ones(1,6),D(3,:)*ones(1,6),D(4,:)*ones(1,6),D(5,:)*ones(1,6),D(6,:)*ones(1,6),zeros(1,36);
   zeros(1,36),D(1,:)*ones(1,6),D(2,:)*ones(1,6),D(3,:)*ones(1,6),D(4,:)*ones(1,6),D(5,:)*ones(1,6),D(6,:)*ones(1,6);
   ones(1,6),zeros(1,66);
   zeros(1,36),ones(1,6),zeros(1,30);
   aeq1(:,1:36),zeros(1,36);
   zeros(1,36),aeq1(:,1:36);
   subtour
   ];                       %不等式约束的技术系数矩阵已生成
b=[Q',ones(1,4),ones(1,10*2),2*ones(1,10*2),3*ones(1,5*2),4*ones(1,1*2)];
                            %不等式约束的资源向量已生成
ub=ones(72,1);              %X取值的上限
lb=zeros(72,1);             %X取值的下限
[x,fval]=intlinprog(f,intcon,A,b,Aeq,beq,lb,ub)

x=reshape(x,6,12);
x=x';                       %将解向量化为矩阵，方便观察

%You can also view this code on
%https://github.com/KATAFANG/Operations-Research/blob/main/FANGTECH.m